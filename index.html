<script>
let map = L.map('map').setView([9.0765, 7.3986], 13);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'OpenStreetMap'
}).addTo(map);

let userLocation;
let routingControl;

// Speak function
function speak(text) {
  let msg = new SpeechSynthesisUtterance(text);
  msg.lang = "en-US";
  msg.rate = 1;
  speechSynthesis.cancel();
  speechSynthesis.speak(msg);
}

// Get user location
map.locate({ setView: true, maxZoom: 16 });

map.on('locationfound', function(e) {
  userLocation = e.latlng;
  L.marker(userLocation)
    .addTo(map)
    .bindPopup("Your Location")
    .openPopup();

  speak("Location detected. Tap on the map to select your destination.");
});

// Click destination
map.on('click', function(e) {
  if (!userLocation) {
    speak("Waiting for your location.");
    return;
  }

  if (routingControl) {
    map.removeControl(routingControl);
  }

  routingControl = L.Routing.control({
    waypoints: [
      L.latLng(userLocation.lat, userLocation.lng),
      L.latLng(e.latlng.lat, e.latlng.lng)
    ],
    routeWhileDragging: false,
    show: true
  }).addTo(map);

  routingControl.on('routesfound', function(e) {
    const steps = e.routes[0].instructions;

    if (steps.length > 0) {
      let firstInstruction = steps[0].text;
      speak(firstInstruction);
    }
  });
});
</script>
