<script>
let map = L.map('map').setView([9.0765, 7.3986], 13);

// Map with names
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: 'OpenStreetMap'
}).addTo(map);

// Text-to-speech
function speak(text) {
  const msg = new SpeechSynthesisUtterance(text);
  msg.lang = "en-US";
  speechSynthesis.cancel();
  speechSynthesis.speak(msg);
}

let userLocation;
let routingControl;

// ⚠️ MANUAL DANGER ZONES (DEMO DATA)
const dangerZones = [
  {
    name: "High Risk Area – Demo",
    lat: 9.0800,
    lng: 7.4100,
    radius: 500
  },
  {
    name: "Restricted Zone – Demo",
    lat: 9.0700,
    lng: 7.3950,
    radius: 400
  }
];

// Draw danger zones
dangerZones.forEach(zone => {
  L.circle([zone.lat, zone.lng], {
    radius: zone.radius,
    color: "red",
    fillColor: "#ff0000",
    fillOpacity: 0.3
  }).addTo(map).bindPopup(`⚠️ ${zone.name}`);
});

// Get user location
map.locate({ watch: true, setView: true, maxZoom: 16 });

map.on('locationfound', function(e) {
  userLocation = e.latlng;

  L.marker(userLocation)
    .addTo(map)
    .bindPopup("Your Location")
    .openPopup();

  // Check distance to danger zones
  dangerZones.forEach(zone => {
    const distance = map.distance(
      userLocation,
      L.latLng(zone.lat, zone.lng)
    );

    if (distance < zone.radius) {
      speak(`Warning. You are approaching ${zone.name}`);
    }
  });
});

// Click map to navigate
map.on('click', function(e) {
  if (!userLocation) {
    speak("Waiting for your location.");
    return;
  }

  if (routingControl) {
    map.removeControl(routingControl);
  }

  routingControl = L.Routing.control({
    waypoints: [
      L.latLng(userLocation.lat, userLocation.lng),
      L.latLng(e.latlng.lat, e.latlng.lng)
    ],
    routeWhileDragging: false,
    show: true
  }).addTo(map);

  speak("Route calculated. Follow the instructions.");
});
</script>
